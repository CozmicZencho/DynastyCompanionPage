<!DOCTYPE html>
<html>
<head>
    <title>{{ dynasty.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <h1>{{ dynasty.name }}</h1>
    <p>{{ dynasty.description }}</p>

    <!-- Coach Info -->
    <div class="info-card">
        <h2>Coach</h2>
        <p><strong>Name:</strong> {{ dynasty.coach.first_name }} {{ dynasty.coach.last_name }}</p>
        <p><strong>College:</strong> {{ dynasty.coach.college }}</p>
        {% if dynasty.coach.alma_mater %}
            <p><strong>Alma Mater:</strong> {{ dynasty.coach.alma_mater }}</p>
        {% endif %}
        <p><strong>Year:</strong> {{ dynasty.coach.year }}</p>
        <a class="btn-link" href="{{ url_for('edit_coach_page', dynasty_id=dynasty.id) }}">Edit Coach</a>
    </div>

    <!-- Seasons -->
    <div class="info-card">
        <h2>Seasons</h2>
        <div class="table-container">
            {% if dynasty.coach.seasons %}
                <table class="seasons-table" id="seasonsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">Year</th>
                            <th onclick="sortTable(1)">Team</th>
                            <th onclick="sortTable(2)">Wins</th>
                            <th onclick="sortTable(3)">Losses</th>
                            <th onclick="sortTable(4)">Achievements</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for season in dynasty.coach.seasons %}
                            <tr data-season-id="{{ season.id }}">
                                <td>{{ season.year }}</td>
                                <td>{{ season.team }}</td>
                                <td>{{ season.wins }}</td>
                                <td>{{ season.losses }}</td>
                                <td>
                                    {% if season.achievements %}
                                        {{ season.achievements | length }}
                                    {% else %}
                                        No achievements
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No seasons recorded yet.</p>
            {% endif %}
        </div>

        <!-- Season Actions -->
        <div class="season-actions">
            <a class="btn-link" href="{{ url_for('add_season', dynasty_id=dynasty.id) }}">Add Season</a>
            <button class="btn-link" id="editSeasonBtn">Edit Season</button>
            <form id="deleteSeasonForm" action="" method="POST" style="display:inline;">
                <button class="delete-btn" type="submit">Delete Season</button>
            </form>
            <button class="btn-link" id="viewAchievementsBtn">View Achievements</button>
        </div>
    </div>

    <a class="back-link" href="/home">Back to Menu</a>

    <!-- JS: Row Selection + Sorting -->
    <script>
    // Row selection
    let selectedRow = null;
    let selectedSeasonId = null;

    document.querySelectorAll("#seasonsTable tbody tr").forEach(row => {
        row.addEventListener("click", () => {
            if (selectedRow) selectedRow.classList.remove("selected");
            row.classList.add("selected");
            selectedRow = row;
            selectedSeasonId = row.getAttribute("data-season-id");
        });
    });

    // Edit Season button
    document.getElementById("editSeasonBtn").addEventListener("click", () => {
        if (selectedSeasonId) {
            window.location.href = `/dynasty/{{ dynasty.id }}/season/${selectedSeasonId}/edit`;
        } else {
            alert("Please select a season first.");
        }
    });

    // Delete Season button
    document.getElementById("deleteSeasonForm").addEventListener("submit", (e) => {
        if (!selectedSeasonId) {
            e.preventDefault();
            alert("Please select a season first.");
        } else {
            e.target.action = `/dynasty/{{ dynasty.id }}/season/${selectedSeasonId}/delete`;
        }
    });

    // View Achievements button
    document.getElementById("viewAchievementsBtn").addEventListener("click", () => {
        if (selectedSeasonId) {
            window.location.href = `/dynasty/{{ dynasty.id }}/season/${selectedSeasonId}/achievements`;
        } else {
            alert("Please select a season first.");
        }
    });

    // Sortable table
    function sortTable(colIndex) {
        const table = document.getElementById("seasonsTable");
        const rows = Array.from(table.rows).slice(1); // skip header
        const asc = table.getAttribute("data-sort-dir") !== "asc";
        
        rows.sort((a, b) => {
            const valA = a.cells[colIndex].innerText;
            const valB = b.cells[colIndex].innerText;
            return isNaN(valA) || isNaN(valB)
                ? valA.localeCompare(valB) * (asc ? 1 : -1)
                : (Number(valA) - Number(valB)) * (asc ? 1 : -1);
        });

        rows.forEach(row => table.tBodies[0].appendChild(row));
        table.setAttribute("data-sort-dir", asc ? "asc" : "desc");
    }
    </script>
</body>
</html>
